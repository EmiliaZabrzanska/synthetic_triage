import streamlit as st
import pandas as pd
from synthcity.plugins import Plugins
from synthcity.plugins.core.dataloader import GenericDataLoader
from sklearn.ensemble import RandomForestClassifier

"""
Part 1: Synthetic data generation and model training
"""

@st.cache_resource
def load_model():

    """
    This function will create the seed data, generate synthetic data using synthcity, 
    and train the model only ONCE to be used when starting the app.
    """

    # Create seed data
    data = {
        'age': [25, 45, 68, 19, 33, 76, 51, 29, 60, 42, 81, 35],
        'fever': [1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0],
        'cough': [1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1],
        'chest_pain': [0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0],
        'breathing_difficulty': [0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0],
        'days_sick': [3, 5, 2, 2, 1, 4, 7, 1, 3, 2, 5, 4],
        'outcome': [
            'self_care', 'see_gp', 'go_to_a&e', 'self_care', 'self_care', 
            'go_to_a&e', 'see_gp', 'self_care', 'go_to_a&e', 'see_gp',
            'go_to_a&e', 'see_gp'
        ]
    }
    seed_df = pd.DataFrame(data)

    # Generate synthetic data
    loader = GenericDataLoader(seed_df, target_column='outcome')
    syn_model = Plugins().get("ctgan")
    syn_model.fit(loader)
    synthetic_data = syn_model.generate(count=1000)
    synthetic_df = synthetic_data.dataframe()

    # Train Triage Model
    X_train = synthetic_df.drop('outcome', axis=1)
    y_train = synthetic_df['outcome']

    model = RandomForestClassifier(n_estimators=100, random_state=42)
    model.fit(X_train, y_train)

    print(" Model and Data laoded successfully ")
    return model

"""
Part 2: Streamlit App for Triage Prediction
"""

# Load trained model
model = load_model()

# Set up Titles and description
st.title("Synthetic Triage Prediction App")
st.write(
    "This app predicts a triage outcome based on patient symptoms. "
    "The model was trained on 100% synthetic data generated by `synthcity`, "
    "a package from the Van der Schaar Lab."
)
st.write("---")

# Create Input controls
st.sidebar.header("Patient Symptom Input")

age = st.sidebar.slider("What is the patient's age?", 0, 100, 25)
days_sick = st.sidebar.slider("How many days has the patient been sick?", 0, 14, 2)
fever = st.sidebar.selectbox("Does the patient have a fever?", ("No", "Yes"))
cough = st.sidebar.selectbox("Does the patient have a cough?", ("No", "Yes"))
chest_pain = st.sidebar.selectbox("Is the patient experiencing chest pain?", ("No", "Yes"))
breathing_difficulty = st.sidebar.selectbox("Is the patient having breathing difficulty?", ("No", "Yes"))

# Convert text to number inputs for the model
fever_int = 1 if fever == "Yes" else 0
cough_int = 1 if cough == "Yes" else 0
chest_pain_int = 1 if chest_pain == "Yes" else 0
breathing_difficulty_int = 1 if breathing_difficulty == "Yes" else 0

# Create a DataFrame for the model input
input_data = pd.DataFrame(
    [[age, fever_int, cough_int, chest_pain_int, breathing_difficulty_int, days_sick]],
    columns=['age', 'fever', 'cough', 'chest_pain', 'breathing_difficulty', 'days_sick']
)

# Predict Triage Outcome
prediction = model.predict(input_data)[0]
prediction_proba = model.predict_proba(input_data)

# Display Prediction
st.subheader("Model Recommendation")

if prediction == 'go_to_a&e':
    st.metric(label="Predicted Outcome", value=prediction, delta="High Urgency", delta_color="off")
    st.error("Recommendation: Seek urgent medical attention.")
elif prediction == 'see_gp':
    st.metric(label="Predicted Outcome", value=prediction, delta="Medium Urgency", delta_color="off")
    st.warning("Recommendation: Contact a GP or local healthcare provider.")
else:
    st.metric(label="Predicted Outcome", value=prediction, delta="Low Urgency", delta_color="inverse")
    st.success("Recommendation: Monitor symptoms and use self-care.")

# Display the raw inputs
st.subheader("Patient Data Entered:")
st.dataframe(input_data)

# Display confidence scores
st.subheader("Prediction Confidence Scores")
proba_df = pd.DataFrame(prediction_proba, columns=model.classes_)
proba_df_transposed = proba_df.T.rename(columns={0: 'Confidence'})
st.bar_chart(proba_df_transposed)